!function(t,e,i){"use strict";function a(){var t=k.outerWidth(),e=k.outerHeight();k.attr({width:t,height:e}),S.mazeView.refocus(S.getVisibleRect()),S.requireRedraw()}t="default"in t?t.default:t,e="default"in e?e.default:e,i="default"in i?i.default:i;var n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),r=new i("mazes");r.version(1).stores({cells:"[maze+x+y], maze, ground, block"}),r.open().catch(function(t){console.error("Couldn't open database",t)});var h=function(){function t(e,i,a){n(this,t),this.grid=[],this.width=Math.round(e),this.height=Math.round(i),a&&(this.saveName=a,this._restoreMaze(a))}return s(t,[{key:"_save",value:function(t,e,i){this.saveName&&(i.maze=this.saveName,i.x=t<0?this.width+t%this.width:t%this.width,i.y=e<0?this.height+e%this.height:e%this.height,r.cells.put(i))}},{key:"_delete",value:function(t){this.saveName&&r.cells.delete([t.maze,t.x,t.y])}},{key:"_restoreMaze",value:function(t,e){var i=this.grid;r.cells.where("maze").equals(t).each(function(t){var e=i[t.y];e||(i[t.y]=e=[],e.cellCount=0),e[t.x]||e.cellCount++,e[t.x]=t}).then(function(){this.mazeView&&this.mazeView.reload()}.bind(this)).catch(function(t){console.error("Failed to restore maze",t)})}},{key:"get",value:function(t,e,i){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(t=t<0?this.width+t%this.width:t%this.width,e=e<0?this.height+e%this.height:e%this.height,a){var n=this.grid[e];n||(this.grid[e]=n=[],n.cellCount=0);var s=n[t];return s?i?s[i]:{cell:s}:(n[t]=s={},n.cellCount++,i?s[i]:{cell:s,created:!0})}var r=this.grid[e]||[],h=r[t],o=h||{};return i?o[i]:{cell:o,fake:!h}}},{key:"toggle",value:function(t,e,i,a){var n=this.get(t,e,null,!0);return n.cell[i]=void 0===a?!n.cell[i]:a,this._save(t,e,n.cell),n}},{key:"clear",value:function(t,e){t=t<0?this.width+t%this.width:t%this.width,e=e<0?this.height+e%this.height:e%this.height;var i=this.grid[e],a=i?i[t]:null;return!!a&&(this._delete(a),t>=0?i.splice(t,1):i[t]=void 0,i.cellCount--,0===i.cellCount&&(e>=0?this.grid.splice(e,1):this.grid[e]=void 0),!0)}}]),t}(),o=function(){function t(e,i){var a=i.x,s=i.y,r=i.w,h=i.h;if(n(this,t),a%1)throw"x must be an integer";if(s%1)throw"y must be an integer";if(r<=0||r%1)throw"width must be an integer > 0";if(h<=0||h%1)throw"height must be an integer > 0";e.mazeView=this,this.maze=e,this.width=1,this.height=1,this.firstRow={y:0,nextRow:null,firstCol:{x:0,nextCol:null,cell:e.get(0,0).cell}},this.refocus({x:a,y:s,w:r,h:h})}return s(t,[{key:"refocus",value:function(t){var e=t.x,i=t.y,a=t.w,n=t.h;if(e!==this.firstRow.firstCol.x||i!==this.firstRow.y||a!==this.width||n!==this.height){if(e%1||i%1)throw"x and y must be integers";if(a<=0||n<=0||a%1||n%1)throw"w and h must be integers > 0";var s=this.firstRow.firstCol.x,r=this.width,h=this.firstRow.y,o=this.height;this.width=a,this.height=n;var l=void 0;if(i>=h&&i<h+o)for(l=this.firstRow;l.y!==i;)l=l.nextRow;else l={y:i,firstCol:{x:e}};for(var c=l,u=i;u<i+n;u++){var d=void 0;if(u>=h&&u<h+o&&e>=s&&e<s+r)for(d=c.firstCol;d.x!==e;)d=d.nextCol;else d={x:e};for(var f=d,w=e;w<e+a;w++)f.cell||(f.cell=this.maze.get(w,u).cell),w+1<e+a?(f.nextCol||(c.firstCol.x===w+1?f.nextCol=c.firstCol:f.nextCol={x:w+1}),f=f.nextCol):(f.nextCol=null,c.firstCol=d);u+1<i+n?(c.nextRow||(this.firstRow.y===u+1?c.nextRow=this.firstRow:c.nextRow={y:u+1,firstCol:{x:e}}),c=c.nextRow):(c.nextRow=null,this.firstRow=l)}}}},{key:"reload",value:function(){for(var t=this.firstRow;t;){for(var e=t.firstCol;e;)e.cell=this.maze.get(e.x,t.y).cell,e=e.nextCol;t=t.nextRow}this.canvasView&&this.canvasView.requireRedraw()}},{key:"get",value:function(t,e,i){return maze.get(t,e,i)}},{key:"getCol",value:function(t,e){for(var i=this.firstRow;i.y!==e;)i=i.nextRow;for(var a=i.firstCol;a.x!==t;)a=a.nextCol;return a}},{key:"toggle",value:function(t,e,i,a){var n=this.maze.toggle(t,e,i,a);return n.created&&(this.getCol(t,e).cell=n.cell),n}},{key:"clear",value:function(t,e){this.maze.clear(t,e)&&(this.getCol(t,e).cell=null)}},{key:"drawTiles",value:function(t){var e=this.firstRow;do{var i=e.firstCol;do i.cell&&t(i.x,e.y,i.cell);while(i=i.nextCol)}while(e=e.nextRow)}}]),t}(),l=120,c=50,u=l/2,d=c/2,f="24px serif",w=!1,v=function(){function t(){n(this,t),this.canvas=document.createElement("canvas"),this.canvas.width=l,this.canvas.height=c;var e=this.canvas.getContext("2d");e.textBaseline="middle",e.textAlign="center",e.font=f,e.shadowColor="#0077FF",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=7,e.strokeStyle="#33FFFF",e.strokeText("IceMaze",u,d),e.fillStyle="white",e.fillText("IceMaze",u,d),w&&(e.strokeStyle="green",e.strokeRect(0,0,l,c))}return s(t,[{key:"draw",value:function(t){t.getContext("2d").drawImage(this.canvas,0,t.height-c)}}]),t}(),g=new v,p=9,y=61,m=1e3/60,x=250,z=100,R=!1,C=function(){function t(e,i){n(this,t),this.canvas=e,this.c2d=e.getContext("2d"),this.targetX=0,this.targetY=0,this.panX=0,this.panY=0,this.tileSize=21,this.redrawRequired=!1,this.lastRedrawTime=0,this.preDrawCallbacks=[],this.postDrawCallbacks=[],this.mazeView=new o(i,this.getVisibleRect()),this.mazeView.canvasView=this,this.requireRedraw()}return s(t,[{key:"getTileCoords",value:function(t){var e=t.x,i=t.y;return{x:Math.round((e-this.canvas.width/2+this.panX*this.tileSize)/this.tileSize),y:Math.round((this.canvas.height/2-i+this.panY*this.tileSize)/this.tileSize)}}},{key:"getCanvasCoords",value:function(t){var e=t.x,i=t.y;return{x:e*this.tileSize-this.panX*this.tileSize+this.canvas.width/2-this.tileSize/2,y:-(i*this.tileSize-this.panY*this.tileSize-this.canvas.height/2)-this.tileSize/2}}},{key:"getVisibleRect",value:function(){var t=this.getTileCoords({x:0,y:this.canvas.height});return{x:t.x,y:t.y,w:Math.ceil(this.canvas.width/this.tileSize)+1,h:Math.ceil(this.canvas.height/this.tileSize)+1}}},{key:"fillTile",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"blue",i=this.getCanvasCoords(t),a=i.x,n=i.y;this.c2d.fillStyle=e,this.c2d.fillRect(a,n,this.tileSize,this.tileSize)}},{key:"zoom",value:function(t){this.zoomTo(this.tileSize*t)}},{key:"freeZoom",value:function(t,e){e=Math.round(e),e%2===0&&(e+=1),e<p?e=p:e>y&&(e=y);var i=e/this.tileSize-1,a=(t.x-this.canvas.width/2)/e*i,n=(this.canvas.height/2-t.y)/e*i;this.panX+=a,this.panY+=n,this.targetX+=a,this.targetY+=n,this.tileSize=e,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw()}},{key:"zoomTo",value:function(t,e){if(t=Math.round(t),t%2===0&&(t+=1),t<p?t=p:t>y&&(t=y),this.preDrawCallbacks=this.preDrawCallbacks.filter(function(t){return!t.zoomStepper}),t===this.tileSize)return void("function"==typeof e&&e());var i=this.tileSize,a=t-i,n=(new Date).getTime(),s=function(){var t=(this.lastRedrawTime-n)/x;t<0?t=0:t>1&&(t=1),this.tileSize=i+t*a,this.mazeView.refocus(this.getVisibleRect()),t<1?this.requireRedraw(s):(console.log("tile size",this.tileSize),this.zoomInProgress=!1,this.requireRedraw(),"function"==typeof e&&e())}.bind(this);s.zoomStepper=!0,this.requireRedraw(s)}},{key:"panUp",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({y:this.targetY+Math.round(t)})}},{key:"panRight",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({x:this.targetX+Math.round(t)})}},{key:"panDown",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({y:this.targetY-Math.round(t)})}},{key:"panLeft",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({x:this.targetX-Math.round(t)})}},{key:"freePan",value:function(t,e){var i=t/this.tileSize,a=e/this.tileSize;this.panX-=i,this.panY+=a,this.targetX-=i,this.targetY+=a,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw()}},{key:"panCenter",value:function(){this.panTo({x:this.panX,y:this.panY})}},{key:"panTo",value:function(t,e){var i=t.x,a=void 0===i?this.targetX:i,n=t.y,s=void 0===n?this.targetY:n;if(this.targetX=Math.round(a),this.targetY=Math.round(s),this.preDrawCallbacks=this.preDrawCallbacks.filter(function(t){return!t.panStepper}),this.targetX===this.panX&&this.targetY===this.panY)return void("function"==typeof e&&e());var r=this.panX,h=this.panY,o=this.targetX-r,l=this.targetY-h,c=Math.sqrt(o*o+l*l),u=c*z,d=(new Date).getTime(),f=function(){var t=(this.lastRedrawTime-d)/u;t<0&&(t=0),t<1?(this.panX=r+t*o,this.panY=h+t*l,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw(f)):(this.panX=this.targetX,this.panY=this.targetY,this.mazeView.refocus(this.getVisibleRect()),console.log("pan center",this.panX,this.panY),this.requireRedraw(),"function"==typeof e&&e())}.bind(this);f.panStepper=!0,this.requireRedraw(f)}},{key:"requireRedraw",value:function(t,e){if("function"==typeof t&&this.preDrawCallbacks.push(t),"function"==typeof e&&this.postDrawCallbacks.push(e),!this.redrawRequired)if(this.redrawRequired=!0,window.requestAnimationFrame)window.requestAnimationFrame(this.redraw.bind(this));else{var i=m-((new Date).getTime()-this.lastRedrawTime);window.setTimeout(this.redraw.bind(this),i>0?i:0)}}},{key:"redraw",value:function(){this.redrawRequired=!1,this.lastRedrawTime=(new Date).getTime();var t=this.preDrawCallbacks;this.preDrawCallbacks=[],t.forEach(function(t){t()}),this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(),this.mazeView.drawTiles(function(t,e,i){i.startTile?this.fillTile({x:t,y:e},"blue"):i.endTile?this.fillTile({x:t,y:e},"green"):i.block?this.fillTile({x:t,y:e},"black"):i.ground&&this.fillTile({x:t,y:e},"brown")}.bind(this)),g.draw(this.canvas);var e=this.postDrawCallbacks;this.postDrawCallbacks=[],e.forEach(function(t){t()})}},{key:"drawGrid",value:function(){var t=this.canvas.width,e=this.canvas.height,i=this.tileSize,a=this.c2d;R&&(a.lineWidth=1,a.strokeStyle="green",a.strokeRect(0,0,t,e)),a.beginPath();for(var n=(t-i)/2%i-i*(this.panX%1);n<t;n+=i)a.moveTo(n,0),a.lineTo(n,e);for(var s=(e-i)/2%i-i*(1-this.panY%1);s<e;s+=i)a.moveTo(0,s),a.lineTo(t,s);a.closePath(),a.lineWidth=1,a.strokeStyle="rgba(0,0,0,.2)",a.stroke()}}]),t}(),k=t("canvas"),b=k[0],T=new h(100,100,"a"),S=new C(b,T);window.maze=T,window.canvasView=S,window.mazeView=S.mazeView,t.notify.addStyle("plain",{html:"<div><span data-notify-text/></div>",classes:{base:{"white-space":"nowrap","background-color":"lightblue",padding:"5px","text-align":"right"},error:{},success:{},info:{},warning:{}}}),t.notify.defaults({style:"plain"});var V=new e.Manager(k[0],{recognizers:[[e.Pan],[e.Tap],[e.Tap,{event:"doubletap",taps:2},["tap"]],[e.Press],[e.Pinch]]}),Y=void 0;V.on("panstart panmove",function(t){"panstart"===t.type&&(Y={x:0,y:0}),S.freePan(t.deltaX-Y.x,t.deltaY-Y.y),Y.x=t.deltaX,Y.y=t.deltaY}),V.on("panend",function(t){console.log("pan",S.getVisibleRect())});var X=void 0;V.on("pinchstart pinchmove pinchend",function(t){"pinchstart"===t.type&&(X=S.tileSize),S.freeZoom(t.center,X*t.scale)}),V.on("tap",function(t){var e=S.getTileCoords(t.center),i=e.x,a=e.y;console.log(t.type,i,a),S.mazeView.toggle(i,a,"ground"),S.requireRedraw()}),V.on("doubletap",function(t){var e=S.getTileCoords(t.center),i=e.x,a=e.y;console.log(t.type,i,a),S.mazeView.toggle(i,a,"block"),S.requireRedraw()}),V.on("press",function(t){var e=S.getTileCoords(t.center),i=e.x,a=e.y;console.log(t.type,i,a),S.mazeView.clear(i,a),S.requireRedraw()}),Mousetrap.bind("up",function(){S.panDown()}),Mousetrap.bind("right",function(){S.panLeft()}),Mousetrap.bind("down",function(){S.panUp()}),Mousetrap.bind("left",function(){S.panRight()}),t(window).on("mousewheel",function(t){S.freeZoom({x:t.clientX,y:t.clientY},S.tileSize*(t.deltaY>0?1.1:.9)),console.log("zoom",S.tileSize)}),a();var M;t(window).on("resize",function(){M&&clearTimeout(M),M=setTimeout(function(){M=null,a()},100)}),console.log("icemaze loaded!")}($,Hammer,Dexie);
//# sourceMappingURL=compiled.js.map
