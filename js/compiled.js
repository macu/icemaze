!function(e,t,i){"use strict";function a(){var e=k.outerWidth(),t=k.outerHeight();k.attr({width:e,height:t}),V.mazeView.refocus(V.getVisibleRect()),V.requireRedraw()}e="default"in e?e.default:e,t="default"in t?t.default:t,i="default"in i?i.default:i;var n=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),r=function(){function e(e,t){var i=[],a=!0,n=!1,s=void 0;try{for(var r,o=e[Symbol.iterator]();!(a=(r=o.next()).done)&&(i.push(r.value),!t||i.length!==t);a=!0);}catch(e){n=!0,s=e}finally{try{!a&&o.return&&o.return()}finally{if(n)throw s}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=new i("mazes");o.version(1).stores({cells:"[maze+x+y], maze, ground, block"}),o.open().catch(function(e){console.error("Couldn't open database",e)});var h=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;if(n(this,e),i<=0||a<=0||i%1||a%1)throw"width and height must be positive integers";this.grid=[],this.width=Math.round(i),this.height=Math.round(a),t&&(this.saveName=t,this._restoreMaze(t))}return s(e,[{key:"_persist",value:function(e,t,i){this.saveName&&(i.maze=this.saveName,i.x=e,i.y=t,o.cells.put(i))}},{key:"_delete",value:function(e){this.saveName&&o.cells.delete([e.maze,e.x,e.y])}},{key:"_restoreMaze",value:function(e){var t=this.grid;o.cells.where("maze").equals(e).each(function(e){var i=t[e.y];i||(t[e.y]=i=[],i.cellCount=0),i[e.x]||i.cellCount++,i[e.x]=e}).then(function(){console.log("Restored maze",e),this.mazeView&&this.mazeView.reloadAll()}.bind(this)).catch(function(e){console.error("Failed to restore maze",e)})}},{key:"_wrap",value:function(e,t){if(e%1||t%1)throw"x and y must be integers";return e=e<0?this.width+e%this.width:e%this.width,t=t<0?this.height+t%this.height:t%this.height,[e,t]}},{key:"get",value:function(e,t,i){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],n=this._wrap(e,t),s=r(n,2);if(e=s[0],t=s[1],a){var o=this.grid[t];o||(this.grid[t]=o=[],o.cellCount=0);var h=o[e];return h?i?h[i]:{cell:h}:(o[e]=h={},o.cellCount++,i?h[i]:{cell:h,created:!0})}var l=this.grid[t]||[],c=l[e],u=c||{};return i?u[i]:{cell:u,fake:!c}}},{key:"toggle",value:function(e,t,i,a){var n=this._wrap(e,t),s=r(n,2);e=s[0],t=s[1];var o=this.get(e,t,null,!0);return o.cell[i]=void 0===a?!o.cell[i]:a,this._persist(e,t,o.cell),this.mazeView&&this.mazeView.reload(e,t,o.cell),o}},{key:"clear",value:function(e,t){var i=this._wrap(e,t),a=r(i,2);e=a[0],t=a[1];var n=this.grid[t],s=n?n[e]:null;return!!s&&(this._delete(s),n[e]=void 0,n.cellCount--,0===n.cellCount&&(this.grid[t]=void 0),this.mazeView&&this.mazeView.reload(e,t,null),!0)}}]),e}(),l=function(){function e(t,i){var a=i.x,s=i.y,r=i.w,o=i.h;n(this,e),t.mazeView=this,this.maze=t,this.width=1,this.height=1,this.firstRow={y:0,nextRow:null,firstCol:{x:0,nextCol:null,cell:t.get(0,0).cell}},this.refocus({x:a,y:s,w:r,h:o})}return s(e,[{key:"refocus",value:function(e){var t=e.x,i=e.y,a=e.w,n=e.h;if(t!==this.firstRow.firstCol.x||i!==this.firstRow.y||a!==this.width||n!==this.height){if(t%1||i%1)throw"x and y must be integers";if(a<=0||n<=0||a%1||n%1)throw"w and h must be positive integers";var s=this.firstRow.firstCol.x,r=this.width,o=this.firstRow.y,h=this.height;this.width=a,this.height=n;var l=void 0;if(i>=o&&i<o+h)for(l=this.firstRow;l.y!==i;)l=l.nextRow;else l={y:i,firstCol:{x:t}};for(var c=l,u=i;u<i+n;u++){var d=void 0;if(u>=o&&u<o+h&&t>=s&&t<s+r)for(d=c.firstCol;d.x!==t;)d=d.nextCol;else d={x:t};for(var f=d,w=t;w<t+a;w++)f.cell||(f.cell=this.maze.get(w,u).cell),w+1<t+a?(f.nextCol||(c.firstCol.x===w+1?f.nextCol=c.firstCol:f.nextCol={x:w+1}),f=f.nextCol):(f.nextCol=null,c.firstCol=d);u+1<i+n?(c.nextRow||(this.firstRow.y===u+1?c.nextRow=this.firstRow:c.nextRow={y:u+1,firstCol:{x:t}}),c=c.nextRow):(c.nextRow=null,this.firstRow=l)}}}},{key:"reloadAll",value:function(){for(var e=this.firstRow;e;){for(var t=e.firstCol;t;)t.cell=this.maze.get(t.x,e.y).cell,t=t.nextCol;e=e.nextRow}this.canvasView&&this.canvasView.requireRedraw()}},{key:"reload",value:function(e,t,i){i=void 0===i?this.maze.get(e,t).cell:i;var a=this.firstRow.firstCol.x,n=this.firstRow.y,s=this.maze.width,r=this.maze.height,o=e<0?s+e%s:e%s,h=t<0?r+t%r:t%r,l=a<0?s+a%s:a%s,c=n<0?r+n%r:n%r;t=n+(h-c),h<c&&(t+=r);for(var u=this.firstRow;t<n+this.height;t+=r){for(;u.y<t;)u=u.nextRow;e=a+(o-l),o<l&&(e+=s);for(var d=u.firstCol;e<a+this.width;e+=s){for(;d.x<e;)d=d.nextCol;console.debug("reload",e,t),d.cell=i}}this.canvasView&&this.canvasView.requireRedraw()}},{key:"drawTiles",value:function(e){var t=this.firstRow;do{var i=t.firstCol;do i.cell&&e(i.x,t.y,i.cell);while(i=i.nextCol)}while(t=t.nextRow)}}]),e}(),c=120,u=50,d=c/2,f=u/2,w="24px serif",v=!1,g=function(){function e(){n(this,e),this.canvas=document.createElement("canvas"),this.canvas.width=c,this.canvas.height=u;var t=this.canvas.getContext("2d");t.textBaseline="middle",t.textAlign="center",t.font=w,t.shadowColor="#0077FF",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=7,t.strokeStyle="#33FFFF",t.strokeText("IceMaze",d,f),t.fillStyle="white",t.fillText("IceMaze",d,f),v&&(t.strokeStyle="green",t.strokeRect(0,0,c,u))}return s(e,[{key:"draw",value:function(e){e.getContext("2d").drawImage(this.canvas,0,e.height-u)}}]),e}(),p=new g,y=9,m=61,z=1e3/60,x=250,R=100,b=!1,C=function(){function e(t,i){n(this,e),this.canvas=t,this.c2d=t.getContext("2d"),this.targetX=0,this.targetY=0,this.panX=0,this.panY=0,this.tileSize=21,this.redrawRequired=!1,this.lastRedrawTime=0,this.preDrawCallbacks=[],this.postDrawCallbacks=[],this.mazeView=new l(i,this.getVisibleRect()),this.mazeView.canvasView=this,this.requireRedraw()}return s(e,[{key:"getTileCoords",value:function(e){var t=e.x,i=e.y;return{x:Math.round((t-this.canvas.width/2+this.panX*this.tileSize)/this.tileSize),y:Math.round((this.canvas.height/2-i+this.panY*this.tileSize)/this.tileSize)}}},{key:"getCanvasCoords",value:function(e){var t=e.x,i=e.y;return{x:t*this.tileSize-this.panX*this.tileSize+this.canvas.width/2-this.tileSize/2,y:-(i*this.tileSize-this.panY*this.tileSize-this.canvas.height/2)-this.tileSize/2}}},{key:"getVisibleRect",value:function(){var e=this.getTileCoords({x:0,y:this.canvas.height});return{x:e.x,y:e.y,w:Math.ceil(this.canvas.width/this.tileSize)+1,h:Math.ceil(this.canvas.height/this.tileSize)+1}}},{key:"fillTile",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"blue",i=this.getCanvasCoords(e),a=i.x,n=i.y;this.c2d.fillStyle=t,this.c2d.fillRect(a,n,this.tileSize,this.tileSize)}},{key:"zoom",value:function(e){this.zoomTo(this.tileSize*e)}},{key:"freeZoom",value:function(e,t){t=Math.round(t),t%2===0&&(t+=1),t<y?t=y:t>m&&(t=m);var i=t/this.tileSize-1,a=(e.x-this.canvas.width/2)/t*i,n=(this.canvas.height/2-e.y)/t*i;this.panX+=a,this.panY+=n,this.targetX+=a,this.targetY+=n,this.tileSize=t,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw()}},{key:"zoomTo",value:function(e,t){if(e=Math.round(e),e%2===0&&(e+=1),e<y?e=y:e>m&&(e=m),this.preDrawCallbacks=this.preDrawCallbacks.filter(function(e){return!e.zoomStepper}),e===this.tileSize)return void("function"==typeof t&&t());var i=this.tileSize,a=e-i,n=(new Date).getTime(),s=function(){var e=(this.lastRedrawTime-n)/x;e<0?e=0:e>1&&(e=1),this.tileSize=i+e*a,this.mazeView.refocus(this.getVisibleRect()),e<1?this.requireRedraw(s):(console.log("tile size",this.tileSize),this.zoomInProgress=!1,this.requireRedraw(),"function"==typeof t&&t())}.bind(this);s.zoomStepper=!0,this.requireRedraw(s)}},{key:"panUp",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({y:this.targetY+Math.round(e)})}},{key:"panRight",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({x:this.targetX+Math.round(e)})}},{key:"panDown",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({y:this.targetY-Math.round(e)})}},{key:"panLeft",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.panTo({x:this.targetX-Math.round(e)})}},{key:"freePan",value:function(e,t){var i=e/this.tileSize,a=t/this.tileSize;this.panX-=i,this.panY+=a,this.targetX-=i,this.targetY+=a,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw()}},{key:"panCenter",value:function(){this.panTo({x:this.panX,y:this.panY})}},{key:"panTo",value:function(e,t){var i=e.x,a=void 0===i?this.targetX:i,n=e.y,s=void 0===n?this.targetY:n;if(this.targetX=Math.round(a),this.targetY=Math.round(s),this.preDrawCallbacks=this.preDrawCallbacks.filter(function(e){return!e.panStepper}),this.targetX===this.panX&&this.targetY===this.panY)return void("function"==typeof t&&t());var r=this.panX,o=this.panY,h=this.targetX-r,l=this.targetY-o,c=Math.sqrt(h*h+l*l),u=c*R,d=(new Date).getTime(),f=function(){var e=(this.lastRedrawTime-d)/u;e<0&&(e=0),e<1?(this.panX=r+e*h,this.panY=o+e*l,this.mazeView.refocus(this.getVisibleRect()),this.requireRedraw(f)):(this.panX=this.targetX,this.panY=this.targetY,this.mazeView.refocus(this.getVisibleRect()),console.log("pan center",this.panX,this.panY),this.requireRedraw(),"function"==typeof t&&t())}.bind(this);f.panStepper=!0,this.requireRedraw(f)}},{key:"requireRedraw",value:function(e,t){if("function"==typeof e&&this.preDrawCallbacks.push(e),"function"==typeof t&&this.postDrawCallbacks.push(t),!this.redrawRequired)if(this.redrawRequired=!0,window.requestAnimationFrame)window.requestAnimationFrame(this.redraw.bind(this));else{var i=z-((new Date).getTime()-this.lastRedrawTime);window.setTimeout(this.redraw.bind(this),i>0?i:0)}}},{key:"redraw",value:function(){this.redrawRequired=!1,this.lastRedrawTime=(new Date).getTime();var e=this.preDrawCallbacks;this.preDrawCallbacks=[],e.forEach(function(e){e()}),this.c2d.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawGrid(),this.mazeView.drawTiles(function(e,t,i){i.startTile?this.fillTile({x:e,y:t},"blue"):i.endTile?this.fillTile({x:e,y:t},"green"):i.block?this.fillTile({x:e,y:t},"black"):i.ground&&this.fillTile({x:e,y:t},"brown")}.bind(this)),p.draw(this.canvas);var t=this.postDrawCallbacks;this.postDrawCallbacks=[],t.forEach(function(e){e()})}},{key:"drawGrid",value:function(){var e=this.canvas.width,t=this.canvas.height,i=this.tileSize,a=this.c2d;b&&(a.lineWidth=1,a.strokeStyle="green",a.strokeRect(0,0,e,t)),a.beginPath();for(var n=(e-i)/2%i-i*(this.panX%1);n<e;n+=i)a.moveTo(n,0),a.lineTo(n,t);for(var s=(t-i)/2%i-i*(1-this.panY%1);s<t;s+=i)a.moveTo(0,s),a.lineTo(e,s);a.closePath(),a.lineWidth=1,a.strokeStyle="rgba(0,0,0,.2)",a.stroke()}}]),e}(),k=e("canvas"),T=k[0],S=new h("a"),V=new C(T,S);window.Maze=h,window.maze=S,window.mazeDb=o,window.canvasView=V,window.mazeView=V.mazeView,window.loadMaze=function(e){window.maze=V.mazeView.maze=S=e,e.mazeView=V.mazeView,V.mazeView.reloadAll()},e.notify.addStyle("plain",{html:"<div><span data-notify-text/></div>",classes:{base:{"white-space":"nowrap","background-color":"lightblue",padding:"5px","text-align":"right"},error:{},success:{},info:{},warning:{}}}),e.notify.defaults({style:"plain"});var Y=new t.Manager(k[0],{recognizers:[[t.Pan],[t.Tap],[t.Tap,{event:"doubletap",taps:2},["tap"]],[t.Press],[t.Pinch]]}),M=void 0;Y.on("panstart panmove",function(e){"panstart"===e.type&&(M={x:0,y:0}),V.freePan(e.deltaX-M.x,e.deltaY-M.y),M.x=e.deltaX,M.y=e.deltaY}),Y.on("panend",function(e){console.log("pan",V.getVisibleRect())});var X=void 0;Y.on("pinchstart pinchmove pinchend",function(e){"pinchstart"===e.type&&(X=V.tileSize),V.freeZoom(e.center,X*e.scale)}),Y.on("tap",function(e){var t=V.getTileCoords(e.center),i=t.x,a=t.y;console.log(e.type,i,a),S.toggle(i,a,"ground")}),Y.on("doubletap",function(e){var t=V.getTileCoords(e.center),i=t.x,a=t.y;console.log(e.type,i,a),S.toggle(i,a,"block")}),Y.on("press",function(e){var t=V.getTileCoords(e.center),i=t.x,a=t.y;console.log(e.type,i,a),S.clear(i,a)}),Mousetrap.bind("up",function(){V.panDown()}),Mousetrap.bind("right",function(){V.panLeft()}),Mousetrap.bind("down",function(){V.panUp()}),Mousetrap.bind("left",function(){V.panRight()}),e(window).on("mousewheel",function(e){V.freeZoom({x:e.clientX,y:e.clientY},V.tileSize*(e.deltaY>0?1.1:.9)),console.log("zoom",V.tileSize)}),a();var q;e(window).on("resize",function(){q&&clearTimeout(q),q=setTimeout(function(){q=null,a()},100)}),console.log("icemaze loaded!")}($,Hammer,Dexie);
//# sourceMappingURL=compiled.js.map
